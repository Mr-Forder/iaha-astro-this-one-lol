---
import { getCollection } from "astro:content";
const {
  limit = 6,
  technology,
  showHeader,
  showPagination,
  frontPage,
} = Astro.props;

const allPosts = (await getCollection("posts"))
  .filter((post) => {
    const isScheduled = new Date(post.data.pubDate).getTime() > Date.now();
    if (technology) {
      return !isScheduled && post.data.alt === technology;
    }
    return !isScheduled;
  })
  .sort((a, b) => {
    return (
      new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
    );
  });

const totalPages = Math.ceil(allPosts.length / limit);

function truncateText(text: string, wordLimit: number = 30) {
  const words = text.split(" ");
  if (words.length > wordLimit) {
    return words.slice(0, wordLimit).join(" ") + "...";
  }
  return text;
}
---

{
  showHeader && (
    <section class="section hero-careers">
      <div class="w-layout-blockcontainer main-container w-container">
        {frontPage && <div class="section-divider home-c-numbers" />}
        <div class="headline-careers">
          <div class="careers-top-tile">
            <div class="spacer-sm" />
            <div class="heading-careers">
              <div class="headline-blog">
                <div class="label">News</div>
                <h1 class="text-h1">
                  {technology ? (
                    `The latest news on ${technology}`
                  ) : (
                    <>
                      Latest News
                      <br />
                      and Articles
                    </>
                  )}
                </h1>
              </div>
            </div>
          </div>
          {frontPage ? (
            <div class="home-b-button-wrap">
              <a href="/news" class="cta-main accent w-inline-block">
                <div class="button-animation-hide">
                  <div class="button-animation-wrap">
                    <div class="button-content-tile">
                      <div>See All News</div>
                      <div class="button-arrow w-embed">
                        <svg
                          width="7"
                          height="10"
                          viewBox="0 0 7 10"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M1 9L5 5L1 1"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                        </svg>
                      </div>
                    </div>
                    <div class="button-content-tile">
                      <div>See All News</div>
                      <div class="button-arrow w-embed">
                        <svg
                          width="7"
                          height="10"
                          viewBox="0 0 7 10"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M1 9L5 5L1 1"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          ) : (
            <div class="home-b-button-wrap">
              <a
                href="/assistive-listening-technologies"
                class="cta-main accent w-inline-block"
              >
                <div class="button-animation-hide">
                  <div class="button-animation-wrap">
                    <div class="button-content-tile">
                      <div>See Assistive Listening Technologies</div>
                      <div class="button-arrow w-embed">
                        <svg
                          width="7"
                          height="10"
                          viewBox="0 0 7 10"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M1 9L5 5L1 1"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                        </svg>
                      </div>
                    </div>
                    <div class="button-content-tile">
                      <div>See Assistive Listening Technologies</div>
                      <div class="button-arrow w-embed">
                        <svg
                          width="7"
                          height="10"
                          viewBox="0 0 7 10"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M1 9L5 5L1 1"
                            stroke="currentColor"
                            stroke-width="2"
                          />
                        </svg>
                      </div>
                    </div>
                  </div>
                </div>
              </a>
            </div>
          )}
          <div class="section-divider home-c-numbers" />
        </div>
      </div>
      {frontPage && (
        <div class="w-layout-blockcontainer main-container w-container">
          <div class="w-layout-grid numbers-halves">
            <div class="numbers-left">
              <div class="">
                <img
                  src="/img/iscve-guide.jpg"
                  loading="lazy"
                  sizes="(max-width: 479px) 100vw, (max-width: 767px) 92vw, (max-width: 991px) 94vw, 95vw"
                  alt="ISCVE launches guide and Code of Practice for Assistive Listening Systems "
                  class="image-cover"
                />
              </div>
            </div>
            <div class="numbers-right">
              <div class="label">Featured News</div>
              <h2 class="no-margins">
                ISCVE launches guide and Code of Practice for Assistive
                Listening Systems
              </h2>
              <div class="section-divider" />
              <div class="text-h5">
                In a world where technology is rapidly advancing, it can be
                overwhelming to keep up with the latest innovations in assistive
                listening systems for the hearing impaired.
              </div>
              <div class="text-h5">
                This comprehensive Guide and Code of Practice are aimed at venue
                managers, audiologists, users, system designers, and
                installation companies looking to improve their knowledge and
                understanding of assistive listening systems.
              </div>
              <div class="home-b-button-wrap">
                <a
                  href="https://iscve.org.uk/iscve-launches-comprehensive-guide-and-a-code-of-practice-for-assistive-listening-systems/"
                  class="cta-main accent w-inline-block"
                >
                  <div class="button-animation-hide">
                    <div class="button-animation-wrap">
                      <div class="button-content-tile">
                        <div>Get ISCVE's Guide</div>
                        <div class="button-arrow w-embed">
                          <svg
                            width="7"
                            height="10"
                            viewBox="0 0 7 10"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path
                              d="M1 9L5 5L1 1"
                              stroke="currentColor"
                              stroke-width="2"
                            />
                          </svg>
                        </div>
                      </div>
                      <div class="button-content-tile">
                        <div>Get ISCVE's Guide</div>
                        <div class="button-arrow w-embed">
                          <svg
                            width="7"
                            height="10"
                            viewBox="0 0 7 10"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                          >
                            <path
                              d="M1 9L5 5L1 1"
                              stroke="currentColor"
                              stroke-width="2"
                            />
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            </div>
          </div>
          <div class="section-divider home-c-numbers" />
        </div>
      )}
    </section>
  )
}

<div class="spacer-lg"></div>

<section class="">
  <div class="w-layout-blockcontainer main-container w-container">
    <div class="spacer-sm"></div>
    <div class="section-divider home-c-numbers"></div>
    <div class="spacer-lg"></div>
    <div class="related-block w-dyn-list">
      <div role="list" class="w-dyn-items">
        <div role="listitem" class="w-dyn-item">
          {
            allPosts[0] && (
              <a
                href={allPosts[0].slug ? `/posts/${allPosts[0].slug}/` : "#"}
                class="article-tile pinned w-inline-block"
              >
                <div class="image-wrap-blog pinned">
                  <img
                    alt=""
                    loading="lazy"
                    src={allPosts[0].data.image?.url}
                    sizes="(max-width: 479px) 100vw, (max-width: 767px) 92vw, 54vw"
                    class="image-cover"
                  />
                </div>
                <div class="article-info-wrap">
                  <div class="">
                    <div class="article-category-wrap">
                      <div class="text-small opacity-50">·</div>
                      <div class="text-small">{allPosts[0].data.alt}</div>
                    </div>
                    <h3 class="teal-text">{allPosts[0].data.title}</h3>
                    <div class="section-divider home-c-numbers" />
                  </div>
                  <div class="text-h4 light-accent">
                    {truncateText(allPosts[0].data.description)}
                  </div>
                </div>
              </a>
            )
          }
        </div>
      </div>
    </div>
  </div>
</section>

<section class="section">
  <div class="w-layout-blockcontainer main-container w-container">
    <div class="headline-related">
      <div class="text-h3">Latest articles</div>
    </div>
    <div class="related-block w-dyn-list">
      <div role="list" class="blog-thirds w-dyn-items" id="posts-container">
        {
          allPosts.slice(0, limit).map((post) => (
            <div role="listitem" class="w-dyn-item">
              <a
                href={post.slug ? `/posts/${post.slug}/` : "#"}
                class="article-tile w-inline-block"
              >
                <div class="image-wrap-blog">
                  <img
                    alt=""
                    loading="lazy"
                    src={post.data.image?.url}
                    sizes="(max-width: 479px) 100vw, (max-width: 767px) 44vw, (max-width: 991px) 46vw, 30vw"
                    class={post.data.image?.alt}
                  />
                </div>
                <div class="article-info-wrap">
                  <div class="article-category-wrap">
                    <div class="text-small teal-text">{post.data.alt}</div>
                    <div class="text-small opacity-50">·</div>
                    <div class="text-small">
                      {post.data.pubDate.toISOString().split("T")[0]}
                    </div>
                  </div>
                  <div class="text-h5">{post.data.title}</div>
                </div>
              </a>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

{
  showPagination && (
    <section>
      <div class="w-layout-blockcontainer main-container w-container">
        <div class="related-block w-dyn-list">
          <div role="navigation" aria-label="List" class="w-pagination-wrapper">
            <button
              id="prev-btn"
              aria-label="Previous Page"
              class="w-pagination-previous pagination-button-article"
              style="display: none;"
            >
              <div class="text-h3 w-inline-block">Previous</div>
            </button>
            <button
              id="next-btn"
              aria-label="Next Page"
              class="w-pagination-next pagination-button-article"
            >
              <div class="text-h3 w-inline-block">Next</div>
            </button>
          </div>
        </div>
      </div>
    </section>
  )
}

<script define:vars={{ allPosts, limit, totalPages }}>
  window.allPosts = allPosts;
  window.currentPage = 1;
  window.postsPerPage = limit;
  window.totalPages = totalPages;

  function updatePosts() {
    const startIndex = (window.currentPage - 1) * window.postsPerPage;
    const endIndex = startIndex + window.postsPerPage;
    const postsToShow = window.allPosts.slice(startIndex, endIndex);

    const container = document.getElementById("posts-container");
    container.innerHTML = postsToShow
      .map(
        (post) => `
    <div role="listitem" class="w-dyn-item">
      <a href="${post.slug ? `/posts/${post.slug}/` : "#"}" class="article-tile w-inline-block">
        <div class="image-wrap-blog">
          <img
            alt=""
            loading="lazy"
            src="${post.data.image?.url || ""}"
            sizes="(max-width: 479px) 100vw, (max-width: 767px) 44vw, (max-width: 991px) 46vw, 30vw"
            class="${post.data.image?.alt || ""}"
          />
        </div>
        <div class="article-info-wrap">
          <div class="article-category-wrap">
            <div class="text-small teal-text">${post.data.alt}</div>
            <div class="text-small opacity-50">·</div>
            <div class="text-small">
              ${post.data.pubDate instanceof Date ? post.data.pubDate.toISOString().split("T")[0] : ""}
            </div>
          </div>
          <div class="text-h5">${post.data.title}</div>
        </div>
      </a>
    </div>
  `
      )
      .join("");

    document.getElementById("prev-btn").style.display =
      window.currentPage > 1 ? "block" : "none";
    document.getElementById("next-btn").style.display =
      window.currentPage < window.totalPages ? "block" : "none";
  }

  document.getElementById("next-btn").addEventListener("click", () => {
    if (window.currentPage < window.totalPages) {
      window.currentPage++;
      updatePosts();
      const element = document.querySelector(".headline-related");
      const offset = 80;
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - offset;
      window.scrollTo({
        top: offsetPosition,
        behavior: "smooth",
      });
    }
  });

  document.getElementById("prev-btn").addEventListener("click", () => {
    if (window.currentPage > 1) {
      window.currentPage--;
      updatePosts();
      const element = document.querySelector(".headline-related");
      const offset = 80;
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.pageYOffset - offset;
      window.scrollTo({
        top: offsetPosition,
        behavior: "smooth",
      });
    }
  });
</script>
